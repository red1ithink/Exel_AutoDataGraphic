Sub CreateWeeklySummaryReport_Final_Stable()

    Dim sourceWS As Worksheet
    Dim reportWS As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim reportRow As Long
    
    Dim startDate As Date, endDate As Date

    Dim reqA As Long, compA As Long
    Dim reqB As Long, compB As Long
    Dim reqC As Long, compC As Long
    
    Dim cellDate As Variant
    Dim processType As String

    Set sourceWS = ThisWorkbook.ActiveSheet
    
    On Error Resume Next
    Set reportWS = ThisWorkbook.Sheets("주간별 현황")
    On Error GoTo 0
    
    If reportWS Is Nothing Then
        Set reportWS = ThisWorkbook.Sheets.Add(After:=sourceWS)
        reportWS.Name = "주간별 현황"
    End If
    reportWS.Cells.Clear
    
    ' --- 2. 리포트 시트에 제목(헤더) 추가 ---
    With reportWS
        .Range("A1").Value = "기간"
        .Range("B1").Value = "A 의뢰"
        .Range("C1").Value = "A 완료"
        .Range("D1").Value = "B 의뢰"
        .Range("E1").Value = "B 완료"
        .Range("F1").Value = "C 의뢰"
        .Range("G1").Value = "C 완료"
        .Range("A1:G1").Font.Bold = True
    End With
    reportRow = 2
    
    ' --- 3. 주차별 데이터 집계 ---
    lastRow = sourceWS.Cells(sourceWS.Rows.Count, "H").End(xlUp).Row
    startDate = DateSerial(2024, 12, 30) ' 2025년 데이터 기준
    
    Do While startDate < DateSerial(2025, 10, 27)
        endDate = startDate + 6
        
        reqA = 0: compA = 0
        reqB = 0: compB = 0
        reqC = 0: compC = 0
        
        For i = 2 To lastRow
            processType = Trim(LCase(sourceWS.Cells(i, "H").Value))
            
            ' --- A 프로세스 집계 (I열, J열) ---
            ' A 의뢰 (I열)
            cellDate = sourceWS.Cells(i, "I").Value
            If Not IsError(cellDate) Then
                If IsDate(cellDate) Then
                    If Int(cellDate) >= startDate And Int(cellDate) <= endDate Then
                        reqA = reqA + 1
                    End If
                End If
            End If
            
            ' A 완료 (J열)
            cellDate = sourceWS.Cells(i, "J").Value
            If Not IsError(cellDate) Then
                If IsDate(cellDate) Then
                    If Int(cellDate) >= startDate And Int(cellDate) <= endDate Then
                        compA = compA + 1
                    End If
                End If
            End If

            ' --- H열 값에 따라 B 또는 C 그룹 집계 (K열, L열) ---
            If processType = "o" Then
                ' B 의뢰 (K열)
                cellDate = sourceWS.Cells(i, "K").Value
                If Not IsError(cellDate) Then
                    If IsDate(cellDate) Then
                        If Int(cellDate) >= startDate And Int(cellDate) <= endDate Then
                            reqB = reqB + 1
                        End If
                    End If
                End If
                
                ' B 완료 (L열)
                cellDate = sourceWS.Cells(i, "L").Value
                If Not IsError(cellDate) Then
                    If IsDate(cellDate) Then
                        If Int(cellDate) >= startDate And Int(cellDate) <= endDate Then
                            compB = compB + 1
                        End If
                    End If
                End If
                
            ElseIf processType = "x" Then
                ' C 의뢰 (K열)
                cellDate = sourceWS.Cells(i, "K").Value
                If Not IsError(cellDate) Then
                    If IsDate(cellDate) Then
                        If Int(cellDate) >= startDate And Int(cellDate) <= endDate Then
                            reqC = reqC + 1
                        End If
                    End If
                End If
                
                ' C 완료 (L열)
                cellDate = sourceWS.Cells(i, "L").Value
                If Not IsError(cellDate) Then
                    If IsDate(cellDate) Then
                        If Int(cellDate) >= startDate And Int(cellDate) <= endDate Then
                            compC = compC + 1
                        End If
                    End If
                End If
            End If
        Next i
        
        ' --- 4. 리포트 시트에 집계된 데이터 입력 ---
        With reportWS
            Dim weekNum As Integer
            weekNum = Application.WorksheetFunction.RoundUp((Day(endDate) + Weekday(DateSerial(Year(endDate), Month(endDate), 1), 2) - 1) / 7, 0)
            .Cells(reportRow, "A").Value = Month(endDate) & "월 " & weekNum & "주 (" & Format(startDate, "mm/dd") & "~" & Format(endDate, "mm/dd") & ")"
            .Cells(reportRow, "B").Value = reqA
            .Cells(reportRow, "C").Value = compA
            .Cells(reportRow, "D").Value = reqB
            .Cells(reportRow, "E").Value = compB
            .Cells(reportRow, "F").Value = reqC
            .Cells(reportRow, "G").Value = compC
        End With
        
        startDate = startDate + 7
        reportRow = reportRow + 1
    Loop
    
    ' --- 5. 마무리 작업 ---
    reportWS.Columns("A:G").AutoFit
    MsgBox "주간별 현황 집계가 완료되었습니다.", vbInformation
End Sub