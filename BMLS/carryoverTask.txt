Sub AnalyzeCarryOverTasks_Final_Fixed()

    Dim sourceWS As Worksheet, reportWS As Worksheet
    Dim lastRow As Long, i As Long, reportRow As Long
    
    Dim startDate As Date, endDate As Date
    Dim carryoverDate As Date
    
    ' --- 전체 이월 현황을 담을 변수 ---
    Dim total_o As Long, total_x As Long ' H='o', H='x'별 전체 이월 건수
    Dim total_o_p_o As Long, total_o_p_x As Long ' H='o' 그룹 내 P열 현황
    Dim total_x_p_o As Long, total_x_p_x As Long ' H='x' 그룹 내 P열 현황
    
    ' --- 주차별 계산을 위한 변수 ---
    Dim weekly_comp_o As Long, weekly_comp_x As Long ' 금주 완료 건수
    Dim running_comp_o As Long, running_comp_x As Long ' 누적 완료 건수
    
    ' 셀 값을 임시로 담을 변수
    Dim reqDateK As Variant, compDateL As Variant
    Dim hValue As String, pValue As String
    Dim isCarryOver As Boolean ' 이월 대상인지 판별하는 변수

    ' --- 1. 사전 분석: 전체 이월 과업 현황 파악 ---
    Set sourceWS = ThisWorkbook.ActiveSheet
    lastRow = sourceWS.Cells(sourceWS.Rows.Count, "K").End(xlUp).Row
    carryoverDate = DateSerial(2024, 12, 30) ' 이월 기준일

    For i = 2 To lastRow
        reqDateK = sourceWS.Cells(i, "K").Value
        
        ' 1. 의뢰일이 기준일 이전인지 확인
        If IsDate(reqDateK) And reqDateK < carryoverDate Then
            compDateL = sourceWS.Cells(i, "L").Value
            isCarryOver = False ' 매번 초기화

            ' 2. 이월 과업인지 확인
            If IsDate(compDateL) Then
                If Year(compDateL) >= 2025 Then isCarryOver = True
            Else
                isCarryOver = True ' 완료일이 비어있으면 이월 대상
            End If

            ' 3. 이월 과업이 맞으면 집계
            If isCarryOver Then
                hValue = Trim(LCase(sourceWS.Cells(i, "H").Value))
                pValue = Trim(LCase(sourceWS.Cells(i, "P").Value))
                
                If hValue = "o" Then
                    total_o = total_o + 1
                    If pValue = "o" Then total_o_p_o = total_o_p_o + 1 Else total_o_p_x = total_o_p_x + 1
                ElseIf hValue = "x" Then
                    total_x = total_x + 1
                    If pValue = "o" Then total_x_p_o = total_x_p_o + 1 Else total_x_p_x = total_x_p_x + 1
                End If
            End If
        End If
    Next i

    ' --- 2. 리포트 시트 설정 ---
    On Error Resume Next
    Set reportWS = ThisWorkbook.Sheets("이월과업 분석")
    On Error GoTo 0
    If reportWS Is Nothing Then Set reportWS = ThisWorkbook.Sheets.Add(After:=sourceWS)
    reportWS.Name = "이월과업 분석"
    reportWS.Cells.Clear
    
    With reportWS
        .Range("A1").Value = "기간"
        .Range("B1").Value = "H='o' 총 이월": .Range("C1").Value = "금주 완료": .Range("D1").Value = "누적 완료": .Range("E1").Value = "잔여 미완료"
        .Range("F1").Value = "H='x' 총 이월": .Range("G1").Value = "금주 완료": .Range("H1").Value = "누적 완료": .Range("I1").Value = "잔여 미완료"
        .Range("A1:I1").Font.Bold = True
        .Range("B1:E1").Interior.Color = RGB(220, 230, 241) ' 하늘색
        .Range("F1:I1").Interior.Color = RGB(226, 239, 218) ' 연두색
    End With
    reportRow = 2
    
    ' --- 3. 주차별 완료 현황 집계 ---
    startDate = DateSerial(2024, 12, 30)
    Do While startDate < DateSerial(2025, 10, 27)
        endDate = startDate + 6
        weekly_comp_o = 0
        weekly_comp_x = 0
        
        For i = 2 To lastRow
             reqDateK = sourceWS.Cells(i, "K").Value
             ' 이월 과업 중에서 (의뢰일 < 기준일)
             If IsDate(reqDateK) And reqDateK < carryoverDate Then
                compDateL = sourceWS.Cells(i, "L").Value
                
                ' --- 완료일이 이번 주에 포함되는지 안전하게 확인 ---
                If IsDate(compDateL) Then ' 1. 날짜가 맞는지 먼저 확인
                    ' 2. 날짜가 맞을 때만 기간을 비교
                    If Int(compDateL) >= startDate And Int(compDateL) <= endDate Then
                        hValue = Trim(LCase(sourceWS.Cells(i, "H").Value))
                        If hValue = "o" Then weekly_comp_o = weekly_comp_o + 1
                        If hValue = "x" Then weekly_comp_x = weekly_comp_x + 1
                    End If
                End If
             End If
        Next i
        
        ' 누적 및 잔여 건수 계산
        running_comp_o = running_comp_o + weekly_comp_o
        running_comp_x = running_comp_x + weekly_comp_x
        
        ' 리포트 시트에 데이터 입력
        With reportWS
            .Cells(reportRow, "A").Value = Month(endDate) & "월 " & Application.WorksheetFunction.RoundUp((Day(endDate) + Weekday(DateSerial(Year(endDate), Month(endDate), 1), 2) - 1) / 7, 0) & "주"
            .Cells(reportRow, "B").Value = total_o
            .Cells(reportRow, "C").Value = weekly_comp_o
            .Cells(reportRow, "D").Value = running_comp_o
            .Cells(reportRow, "E").Value = total_o - running_comp_o
            .Cells(reportRow, "F").Value = total_x
            .Cells(reportRow, "G").Value = weekly_comp_x
            .Cells(reportRow, "H").Value = running_comp_x
            .Cells(reportRow, "I").Value = total_x - running_comp_x
        End With
        
        startDate = startDate + 7
        reportRow = reportRow + 1
    Loop

    ' --- 4. 마무리 작업 및 요약 메시지 ---
    reportWS.Columns("A:I").AutoFit
    
    Dim summaryMsg As String
    summaryMsg = "이월 과업 분석이 완료되었습니다." & vbCrLf & vbCrLf & _
                 "--- [ H = 'o' ] ---" & vbCrLf & _
                 "총 이월 건수: " & total_o & " 건" & vbCrLf & _
                 "  - 이 중 P='o': " & total_o_p_o & " 건" & vbCrLf & _
                 "  - 이 중 P!='o': " & total_o_p_x & " 건" & vbCrLf & vbCrLf & _
                 "--- [ H = 'x' ] ---" & vbCrLf & _
                 "총 이월 건수: " & total_x & " 건" & vbCrLf & _
                 "  - 이 중 P='o': " & total_x_p_o & " 건" & vbCrLf & _
                 "  - 이 중 P!='o': " & total_x_p_x & " 건"

    MsgBox summaryMsg, vbInformation, "분석 완료"
End Sub

